<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management - Admin Dashboard</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üçΩÔ∏è Admin</h2>
                <span class="tenant-name" id="tenantName">Restaurant</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/" class="nav-item" data-page="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/menu.html" class="nav-item active" data-page="menu">
                    <span class="nav-icon">üìã</span>
                    <span>Menu</span>
                </a>
                <a href="/admin/ingredients.html" class="nav-item" data-page="ingredients">
                    <span class="nav-icon">ü•ó</span>
                    <span>Ingredients</span>
                </a>
                <a href="/admin/settings.html" class="nav-item" data-page="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <span id="userEmail">admin@restaurant.local</span>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h1>Menu Management</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showAddCategoryModal()">+ Add Category</button>
                    <button class="btn btn-success" onclick="showAddDishModal()">+ Add Dish</button>
                </div>
            </header>

            <!-- Login Form -->
            <div class="login-container" id="loginContainer">
                <div class="login-card">
                    <h2>Admin Login</h2>
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required placeholder="admin@restaurant.local">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" name="password" required placeholder="Enter password">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Login</button>
                        <p class="login-error" id="loginError"></p>
                    </form>
                </div>
            </div>

            <!-- Menu Content -->
            <div class="menu-content" id="menuContent" style="display: none;">
                <!-- Toolbar -->
                <div class="toolbar">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search dishes..." oninput="filterDishes()">
                    <select class="filter-select" id="categoryFilter" onchange="filterDishes()">
                        <option value="">All Categories</option>
                    </select>
                    <select class="filter-select" id="availabilityFilter" onchange="filterDishes()">
                        <option value="">All Status</option>
                        <option value="available">Available</option>
                        <option value="unavailable">Unavailable</option>
                    </select>
                </div>

                <!-- Categories Section -->
                <div class="card">
                    <h3>Categories</h3>
                    <div class="item-list" id="categoriesList">
                        <p class="loading">Loading categories...</p>
                    </div>
                </div>

                <!-- Dishes Section -->
                <div class="card">
                    <h3>Dishes</h3>
                    <div class="item-list" id="dishesList">
                        <p class="loading">Loading dishes...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Add Category</h3>
                <button class="modal-close" onclick="hideModal('categoryModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" name="id" id="categoryId">
                    <div class="form-group">
                        <label for="categoryName">Name *</label>
                        <input type="text" id="categoryName" name="name" required placeholder="e.g., Appetizers">
                    </div>
                    <div class="form-group">
                        <label for="categoryDescription">Description</label>
                        <textarea id="categoryDescription" name="description" placeholder="Category description..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('categoryModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveCategory()">Save Category</button>
            </div>
        </div>
    </div>

    <!-- Dish Modal -->
    <div class="modal" id="dishModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="dishModalTitle">Add Dish</h3>
                <button class="modal-close" onclick="hideModal('dishModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="dishForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="dishId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dishName">Name *</label>
                            <input type="text" id="dishName" name="name" required placeholder="e.g., Margherita Pizza">
                        </div>
                        <div class="form-group">
                            <label for="dishCategory">Category *</label>
                            <select id="dishCategory" name="category_id" required>
                                <option value="">Select category</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dishDescription">Description</label>
                        <textarea id="dishDescription" name="description" placeholder="Describe the dish..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dishPrice">Price *</label>
                            <input type="number" id="dishPrice" name="price" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Options</label>
                            <div class="form-check">
                                <input type="checkbox" id="dishVegetarian" name="is_vegetarian">
                                <label for="dishVegetarian">üå± Vegetarian</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" id="dishAvailable" name="is_available" checked>
                                <label for="dishAvailable">‚úì Available</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dishAllergens">Allergens</label>
                        <input type="text" id="dishAllergens" name="allergens_text" placeholder="e.g., gluten, dairy (comma separated)">
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                        <div class="image-upload" onclick="document.getElementById('dishImage').click()">
                            <input type="file" id="dishImage" name="image" accept="image/*" onchange="previewImage(this)">
                            <p>Click to upload image</p>
                            <img id="imagePreview" class="image-preview" style="display: none;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('dishModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveDish()">Save Dish</button>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script>
        let categories = [];
        let dishes = [];

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        window.onAuthenticated = async function() {
            await loadCategories();
            await loadDishes();
        };

        // Load data
        async function loadCategories() {
            try {
                categories = await apiRequest('/api/admin/categories');
                renderCategories();
                populateCategoryFilters();
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        async function loadDishes() {
            try {
                dishes = await apiRequest('/api/admin/dishes?include_ingredients=true&available=all');
                renderDishes();
            } catch (error) {
                console.error('Failed to load dishes:', error);
            }
        }

        // Render functions
        function renderCategories() {
            const list = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                list.innerHTML = '<p class="empty">No categories yet. Add your first category!</p>';
                return;
            }
            
            list.innerHTML = categories.map(cat => `
                <div class="item-card" draggable="true" data-id="${cat.id}">
                    <span class="item-drag-handle">‚ãÆ‚ãÆ</span>
                    <div class="item-info">
                        <div class="item-name">${escapeHtml(cat.name)}</div>
                        <div class="item-description">${escapeHtml(cat.description || 'No description')}</div>
                    </div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editCategory('${cat.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
            
            initDragAndDrop('categoriesList', reorderCategories);
        }

        function renderDishes(filteredDishes = null) {
            const list = document.getElementById('dishesList');
            const dishesToRender = filteredDishes || dishes;
            
            if (dishesToRender.length === 0) {
                list.innerHTML = '<p class="empty">No dishes found.</p>';
                return;
            }
            
            list.innerHTML = dishesToRender.map(dish => `
                <div class="item-card" data-id="${dish.id}">
                    ${dish.image_url ? `<img src="${dish.image_url}" class="item-image" alt="${escapeHtml(dish.name)}">` : '<div class="item-image" style="background: #f5f6fa; display: flex; align-items: center; justify-content: center;">üçΩÔ∏è</div>'}
                    <div class="item-info">
                        <div class="item-name">${escapeHtml(dish.name)}</div>
                        <div class="item-description">${escapeHtml(dish.description || 'No description')}</div>
                        <div class="item-meta">
                            <span class="item-badge">${escapeHtml(dish.category_name || 'Uncategorized')}</span>
                            ${dish.is_vegetarian ? '<span class="item-badge vegetarian">üå± Vegetarian</span>' : ''}
                            ${!dish.is_available ? '<span class="item-badge unavailable">Unavailable</span>' : ''}
                        </div>
                    </div>
                    <div class="item-price">$${parseFloat(dish.price).toFixed(2)}</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="toggleAvailability('${dish.id}')">${dish.is_available ? 'üö´' : '‚úì'}</button>
                        <button class="btn btn-sm btn-secondary" onclick="editDish('${dish.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDish('${dish.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function populateCategoryFilters() {
            const filter = document.getElementById('categoryFilter');
            const dishSelect = document.getElementById('dishCategory');
            
            const options = categories.map(cat => 
                `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`
            ).join('');
            
            filter.innerHTML = '<option value="">All Categories</option>' + options;
            dishSelect.innerHTML = '<option value="">Select category</option>' + options;
        }

        function filterDishes() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const availability = document.getElementById('availabilityFilter').value;
            
            let filtered = dishes.filter(dish => {
                const matchesSearch = !search || 
                    dish.name.toLowerCase().includes(search) ||
                    (dish.description && dish.description.toLowerCase().includes(search));
                const matchesCategory = !category || dish.category_id === category;
                const matchesAvailability = !availability ||
                    (availability === 'available' && dish.is_available) ||
                    (availability === 'unavailable' && !dish.is_available);
                
                return matchesSearch && matchesCategory && matchesAvailability;
            });
            
            renderDishes(filtered);
        }

        // Category CRUD
        function showAddCategoryModal() {
            document.getElementById('categoryModalTitle').textContent = 'Add Category';
            resetForm('categoryForm');
            showModal('categoryModal');
        }

        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;
            
            document.getElementById('categoryModalTitle').textContent = 'Edit Category';
            populateForm('categoryForm', category);
            showModal('categoryModal');
        }

        async function saveCategory() {
            const data = getFormData('categoryForm');
            const id = data.id;
            delete data.id;
            
            try {
                if (id) {
                    await apiRequest(`/api/admin/categories/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showNotification('Category updated', 'success');
                } else {
                    await apiRequest('/api/admin/categories', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showNotification('Category created', 'success');
                }
                
                hideModal('categoryModal');
                await loadCategories();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function deleteCategory(id) {
            confirmDelete('Are you sure you want to delete this category? All dishes in this category will also be deleted.', async () => {
                try {
                    await apiRequest(`/api/admin/categories/${id}`, { method: 'DELETE' });
                    showNotification('Category deleted', 'success');
                    await loadCategories();
                    await loadDishes();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });
        }

        async function reorderCategories(order) {
            try {
                await apiRequest('/api/admin/categories/reorder', {
                    method: 'PUT',
                    body: JSON.stringify({ order })
                });
                await loadCategories();
            } catch (error) {
                showNotification('Failed to reorder', 'error');
            }
        }

        // Dish CRUD
        function showAddDishModal() {
            document.getElementById('dishModalTitle').textContent = 'Add Dish';
            resetForm('dishForm');
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('dishAvailable').checked = true;
            showModal('dishModal');
        }

        function editDish(id) {
            const dish = dishes.find(d => d.id === id);
            if (!dish) return;
            
            document.getElementById('dishModalTitle').textContent = 'Edit Dish';
            
            // Populate form
            document.getElementById('dishId').value = dish.id;
            document.getElementById('dishName').value = dish.name;
            document.getElementById('dishCategory').value = dish.category_id;
            document.getElementById('dishDescription').value = dish.description || '';
            document.getElementById('dishPrice').value = dish.price;
            document.getElementById('dishVegetarian').checked = dish.is_vegetarian;
            document.getElementById('dishAvailable').checked = dish.is_available;
            document.getElementById('dishAllergens').value = (dish.allergens || []).join(', ');
            
            if (dish.image_url) {
                const preview = document.getElementById('imagePreview');
                preview.src = dish.image_url;
                preview.style.display = 'block';
            }
            
            showModal('dishModal');
        }

        async function saveDish() {
            const form = document.getElementById('dishForm');
            const formData = new FormData(form);
            const id = formData.get('id');
            
            // Convert allergens text to array
            const allergensText = formData.get('allergens_text');
            if (allergensText) {
                const allergens = allergensText.split(',').map(a => a.trim()).filter(a => a);
                formData.set('allergens', JSON.stringify(allergens));
            }
            formData.delete('allergens_text');
            
            // Handle checkboxes
            formData.set('is_vegetarian', document.getElementById('dishVegetarian').checked);
            formData.set('is_available', document.getElementById('dishAvailable').checked);
            
            try {
                if (id) {
                    formData.delete('id');
                    await apiRequestFormData(`/api/admin/dishes/${id}`, formData, 'PUT');
                    showNotification('Dish updated', 'success');
                } else {
                    formData.delete('id');
                    await apiRequestFormData('/api/admin/dishes', formData, 'POST');
                    showNotification('Dish created', 'success');
                }
                
                hideModal('dishModal');
                await loadDishes();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function deleteDish(id) {
            confirmDelete('Are you sure you want to delete this dish?', async () => {
                try {
                    await apiRequest(`/api/admin/dishes/${id}`, { method: 'DELETE' });
                    showNotification('Dish deleted', 'success');
                    await loadDishes();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });
        }

        async function toggleAvailability(id) {
            try {
                await apiRequest(`/api/admin/dishes/${id}/toggle-availability`, { method: 'PATCH' });
                await loadDishes();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Helpers
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
