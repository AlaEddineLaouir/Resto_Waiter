// Prisma schema for Multi-Tenant Restaurant Menu SaaS
// Production-grade schema with i18n, locations, options, allergens, and dietary flags

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// TENANT (Restaurant - Root entity for multi-tenancy)
// ============================================
model Tenant {
  id              String    @id @default(uuid()) @db.Uuid
  name            String    @db.VarChar(255)
  slug            String    @unique @db.VarChar(100)
  email           String?   @db.VarChar(255)
  phone           String?   @db.VarChar(50)
  address         String?
  status          String    @default("active") @db.VarChar(20) // active|suspended|closed
  defaultCurrency String    @default("EUR") @map("default_currency") @db.VarChar(10)
  priceTaxPolicy  String    @default("tax_included") @map("price_tax_policy") @db.VarChar(20)
  defaultLocale   String    @default("en-US") @map("default_locale") @db.VarChar(10)
  config          Json      @default("{}")
  branding        Json      @default("{\"primaryColor\": \"#4a90a4\", \"secondaryColor\": \"#2c3e50\"}")
  apiKeyEncrypted String?   @map("api_key_encrypted")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  brands         Brand[]
  locations      Location[]
  menus          Menu[]
  ingredients    Ingredient[]
  adminUsers     AdminUser[]
  auditLogs      AuditLog[]
  chatSessions   ChatSession[]
  subscription   RestaurantSubscription?
  usageAnalytics UsageAnalytics[]
  locales        TenantLocale[]
  assets         Asset[]

  @@index([slug])
  @@map("tenants")
}

// ============================================
// TENANT LOCALES (Supported languages per tenant)
// ============================================
model TenantLocale {
  id        String  @id @default(uuid()) @db.Uuid
  tenantId  String  @map("tenant_id") @db.Uuid
  locale    String  @db.VarChar(10)
  isDefault Boolean @default(false) @map("is_default")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, locale])
  @@map("tenant_locales")
}

// ============================================
// BRANDS (Organizations within a tenant)
// ============================================
model Brand {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String   @db.VarChar(255)
  slug      String   @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  locations Location[]
  menus     Menu[]

  @@unique([tenantId, slug])
  @@map("brands")
}

// ============================================
// LOCATIONS (Physical branches, ghost kitchens)
// ============================================
model Location {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  brandId         String   @map("brand_id") @db.Uuid
  slug            String   @db.VarChar(100)
  name            String   @db.VarChar(255)
  addressLine1    String?  @map("address_line1")
  addressLine2    String?  @map("address_line2")
  city            String?  @db.VarChar(100)
  postalCode      String?  @map("postal_code") @db.VarChar(20)
  countryCode     String   @default("FR") @map("country_code") @db.Char(2)
  timezone        String   @default("Europe/Paris") @db.VarChar(50)
  phone           String?  @db.VarChar(30)
  email           String?  @db.VarChar(255)
  serviceDineIn   Boolean  @default(true) @map("service_dine_in")
  serviceTakeaway Boolean  @default(true) @map("service_takeaway")
  serviceDelivery Boolean  @default(false) @map("service_delivery")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand            Brand             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  diningTables     DiningTable[]
  menuPublications MenuPublication[]

  @@unique([tenantId, slug])
  @@unique([tenantId, brandId, name])
  @@index([tenantId])
  @@map("locations")
}

// ============================================
// DINING TABLES (For QR codes)
// ============================================
model DiningTable {
  id          String  @id @default(uuid()) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  locationId  String  @map("location_id") @db.Uuid
  label       String  @db.VarChar(50)
  qrCodeValue String  @map("qr_code_value") @db.VarChar(255)
  isActive    Boolean @default(true) @map("is_active")

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([tenantId, locationId, label])
  @@unique([tenantId, locationId, qrCodeValue])
  @@map("dining_tables")
}

// ============================================
// MENUS (Menu containers like Dinner, Lunch, Drinks)
// ============================================
model Menu {
  id             String    @id @default(uuid()) @db.Uuid
  tenantId       String    @map("tenant_id") @db.Uuid
  brandId        String    @map("brand_id") @db.Uuid
  code           String    @db.VarChar(50)
  currency       String?   @db.VarChar(10)
  priceTaxPolicy String?   @map("price_tax_policy") @db.VarChar(20)
  defaultLocale  String?   @map("default_locale") @db.VarChar(10)
  status         String    @default("draft") @db.VarChar(20) // draft | published | archived
  isActive       Boolean   @default(true) @map("is_active")
  publishedAt    DateTime? @map("published_at") @db.Timestamptz
  archivedAt     DateTime? @map("archived_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  tenant            Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand             Brand                  @relation(fields: [brandId], references: [id], onDelete: Cascade)
  translations      MenuI18n[]
  availabilityRules MenuAvailabilityRule[]
  lines             MenuLine[]
  menuSections      MenuSection[]
  menuItems         MenuItem[]
  optionGroups      OptionGroup[]
  publications      MenuPublication[]

  @@unique([tenantId, brandId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("menus")
}

model MenuI18n {
  id          String  @id @default(uuid()) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  menuId      String  @map("menu_id") @db.Uuid
  locale      String  @db.VarChar(10)
  name        String  @db.VarChar(255)
  description String?

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([tenantId, menuId, locale])
  @@map("menu_i18n")
}

model MenuAvailabilityRule {
  id             String    @id @default(uuid()) @db.Uuid
  tenantId       String    @map("tenant_id") @db.Uuid
  menuId         String    @map("menu_id") @db.Uuid
  serviceType    String    @default("any") @map("service_type") @db.VarChar(20)
  dowMask        Int       @map("dow_mask")
  startTimeLocal String    @map("start_time_local") @db.VarChar(5)
  endTimeLocal   String    @map("end_time_local") @db.VarChar(5)
  startDateLocal DateTime? @map("start_date_local") @db.Date
  endDateLocal   DateTime? @map("end_date_local") @db.Date

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@map("menu_availability_rules")
}

// ============================================
// MENU PUBLICATION (For location-specific assignments)
// ============================================
model MenuPublication {
  id         String    @id @default(uuid()) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  locationId String    @map("location_id") @db.Uuid
  menuId     String    @map("menu_id") @db.Uuid
  goesLiveAt DateTime  @default(now()) @map("goes_live_at") @db.Timestamptz
  retiresAt  DateTime? @map("retires_at") @db.Timestamptz
  isCurrent  Boolean   @default(true) @map("is_current")

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  menu     Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([tenantId, locationId, menuId])
  @@map("menu_publications")
}

// ============================================
// MENU LINE (Unified content lines: sections or items)
// ============================================
model MenuLine {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  menuId       String   @map("menu_id") @db.Uuid
  lineType     String   @map("line_type") @db.VarChar(20) // section | item
  sectionId    String?  @map("section_id") @db.Uuid
  itemId       String?  @map("item_id") @db.Uuid
  parentLineId String?  @map("parent_line_id") @db.Uuid // For nested sections
  displayOrder Int      @default(0) @map("display_order")
  isEnabled    Boolean  @default(true) @map("is_enabled") // Availability toggle
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  menu       Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  section    Section?   @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  item       Item?      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  parentLine MenuLine?  @relation("MenuLineNesting", fields: [parentLineId], references: [id], onDelete: SetNull)
  childLines MenuLine[] @relation("MenuLineNesting")

  @@unique([tenantId, menuId, sectionId], map: "menu_line_section_unique")
  @@unique([tenantId, menuId, itemId], map: "menu_line_item_unique")
  @@index([tenantId, menuId])
  @@index([tenantId, menuId, parentLineId])
  @@map("menu_lines")
}

// ============================================
// SECTIONS (Reusable categories, shared across menu versions)
// ============================================
model Section {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  translations SectionI18n[]
  items        Item[]
  menuSections MenuSection[]
  menuLines    MenuLine[]

  @@index([tenantId])
  @@map("sections")
}

// Join table: Menu <-> Section (with display order per menu)
model MenuSection {
  id           String @id @default(uuid()) @db.Uuid
  tenantId     String @map("tenant_id") @db.Uuid
  menuId       String @map("menu_id") @db.Uuid
  sectionId    String @map("section_id") @db.Uuid
  displayOrder Int    @default(0) @map("display_order")

  menu    Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)
  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, menuId, sectionId])
  @@index([tenantId, menuId])
  @@map("menu_sections")
}

model SectionI18n {
  id          String  @id @default(uuid()) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  sectionId   String  @map("section_id") @db.Uuid
  locale      String  @db.VarChar(10)
  title       String  @db.VarChar(255)
  description String?

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, sectionId, locale])
  @@map("section_i18n")
}

// ============================================
// ITEMS (Reusable dishes/drinks, shared across menu versions)
// ============================================
model Item {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  sectionId      String   @map("section_id") @db.Uuid
  sku            String?  @db.VarChar(50)
  isVisible      Boolean  @default(true) @map("is_visible")
  spicinessLevel Int?     @map("spiciness_level") @db.SmallInt
  calories       Int?
  imageAssetId   String?  @map("image_asset_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  section        Section             @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  imageAsset     Asset?              @relation(fields: [imageAssetId], references: [id], onDelete: SetNull)
  translations   ItemI18n[]
  priceBase      ItemPriceBase?
  priceOverrides ItemPriceOverride[]
  optionGroups   ItemOptionGroup[]
  allergens      ItemAllergen[]
  dietaryFlags   ItemDietaryFlag[]
  ingredients    ItemIngredient[]
  menuItems      MenuItem[]
  menuLines      MenuLine[]

  @@index([tenantId, sectionId])
  @@map("items")
}

// Join table: Menu <-> Item (with section context and display order)
model MenuItem {
  id           String @id @default(uuid()) @db.Uuid
  tenantId     String @map("tenant_id") @db.Uuid
  menuId       String @map("menu_id") @db.Uuid
  sectionId    String @map("section_id") @db.Uuid
  itemId       String @map("item_id") @db.Uuid
  displayOrder Int    @default(0) @map("display_order")

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([tenantId, menuId, itemId])
  @@index([tenantId, menuId, sectionId])
  @@map("menu_items")
}

model ItemI18n {
  id          String  @id @default(uuid()) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  itemId      String  @map("item_id") @db.Uuid
  locale      String  @db.VarChar(10)
  name        String  @db.VarChar(255)
  description String?

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([tenantId, itemId, locale])
  @@map("item_i18n")
}

// ============================================
// ITEM PRICING
// ============================================
model ItemPriceBase {
  id          String @id @default(uuid()) @db.Uuid
  tenantId    String @map("tenant_id") @db.Uuid
  itemId      String @unique @map("item_id") @db.Uuid
  currency    String @db.VarChar(10)
  amountMinor BigInt @map("amount_minor")

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("item_price_base")
}

model ItemPriceOverride {
  id             String    @id @default(uuid()) @db.Uuid
  tenantId       String    @map("tenant_id") @db.Uuid
  itemId         String    @map("item_id") @db.Uuid
  locationId     String?   @map("location_id") @db.Uuid
  serviceType    String    @default("any") @map("service_type") @db.VarChar(20)
  dowMask        Int?      @map("dow_mask")
  startTimeLocal String?   @map("start_time_local") @db.VarChar(5)
  endTimeLocal   String?   @map("end_time_local") @db.VarChar(5)
  startDateLocal DateTime? @map("start_date_local") @db.Date
  endDateLocal   DateTime? @map("end_date_local") @db.Date
  currency       String?   @db.VarChar(10)
  amountMinor    BigInt    @map("amount_minor")

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("item_price_overrides")
}

// ============================================
// OPTION GROUPS & OPTIONS (Sizes, Sides, Add-ons)
// ============================================
model OptionGroup {
  id            String  @id @default(uuid()) @db.Uuid
  tenantId      String  @map("tenant_id") @db.Uuid
  menuId        String  @map("menu_id") @db.Uuid
  code          String? @db.VarChar(50)
  selectionMode String  @map("selection_mode") @db.VarChar(20)
  minSelect     Int     @default(0) @map("min_select")
  maxSelect     Int?    @map("max_select")
  isRequired    Boolean @default(false) @map("is_required")
  displayOrder  Int     @default(0) @map("display_order")
  isActive      Boolean @default(true) @map("is_active")

  menu         Menu              @relation(fields: [menuId], references: [id], onDelete: Cascade)
  translations OptionGroupI18n[]
  items        ItemOptionGroup[]
  options      OptionItem[]

  @@map("option_groups")
}

model OptionGroupI18n {
  id            String  @id @default(uuid()) @db.Uuid
  tenantId      String  @map("tenant_id") @db.Uuid
  optionGroupId String  @map("option_group_id") @db.Uuid
  locale        String  @db.VarChar(10)
  name          String  @db.VarChar(255)
  description   String?

  optionGroup OptionGroup @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)

  @@unique([tenantId, optionGroupId, locale])
  @@map("option_group_i18n")
}

model ItemOptionGroup {
  id            String @id @default(uuid()) @db.Uuid
  tenantId      String @map("tenant_id") @db.Uuid
  itemId        String @map("item_id") @db.Uuid
  optionGroupId String @map("option_group_id") @db.Uuid
  displayOrder  Int    @default(0) @map("display_order")

  item        Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  optionGroup OptionGroup @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)

  @@unique([tenantId, itemId, optionGroupId])
  @@map("item_option_groups")
}

model OptionItem {
  id            String  @id @default(uuid()) @db.Uuid
  tenantId      String  @map("tenant_id") @db.Uuid
  optionGroupId String  @map("option_group_id") @db.Uuid
  code          String? @db.VarChar(50)
  displayOrder  Int     @default(0) @map("display_order")
  isDefault     Boolean @default(false) @map("is_default")
  isActive      Boolean @default(true) @map("is_active")

  optionGroup  OptionGroup          @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)
  translations OptionItemI18n[]
  price        OptionItemPrice?
  allergens    OptionItemAllergen[]

  @@map("option_items")
}

model OptionItemI18n {
  id           String  @id @default(uuid()) @db.Uuid
  tenantId     String  @map("tenant_id") @db.Uuid
  optionItemId String  @map("option_item_id") @db.Uuid
  locale       String  @db.VarChar(10)
  name         String  @db.VarChar(255)
  description  String?

  optionItem OptionItem @relation(fields: [optionItemId], references: [id], onDelete: Cascade)

  @@unique([tenantId, optionItemId, locale])
  @@map("option_item_i18n")
}

model OptionItemPrice {
  id           String @id @default(uuid()) @db.Uuid
  tenantId     String @map("tenant_id") @db.Uuid
  optionItemId String @unique @map("option_item_id") @db.Uuid
  currency     String @db.VarChar(10)
  deltaMinor   BigInt @map("delta_minor")

  optionItem OptionItem @relation(fields: [optionItemId], references: [id], onDelete: Cascade)

  @@map("option_item_prices")
}

// ============================================
// ALLERGENS (Master vocabulary)
// ============================================
model Allergen {
  code      String @id @db.VarChar(50)
  sortOrder Int    @default(0) @map("sort_order")

  translations    AllergenI18n[]
  itemAllergens   ItemAllergen[]
  optionAllergens OptionItemAllergen[]

  @@map("allergens")
}

model AllergenI18n {
  id           String @id @default(uuid()) @db.Uuid
  allergenCode String @map("allergen_code") @db.VarChar(50)
  locale       String @db.VarChar(10)
  name         String @db.VarChar(100)

  allergen Allergen @relation(fields: [allergenCode], references: [code], onDelete: Cascade)

  @@unique([allergenCode, locale])
  @@map("allergen_i18n")
}

model ItemAllergen {
  id           String @id @default(uuid()) @db.Uuid
  tenantId     String @map("tenant_id") @db.Uuid
  itemId       String @map("item_id") @db.Uuid
  allergenCode String @map("allergen_code") @db.VarChar(50)

  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  allergen Allergen @relation(fields: [allergenCode], references: [code], onDelete: Restrict)

  @@unique([tenantId, itemId, allergenCode])
  @@map("item_allergens")
}

model OptionItemAllergen {
  id           String @id @default(uuid()) @db.Uuid
  tenantId     String @map("tenant_id") @db.Uuid
  optionItemId String @map("option_item_id") @db.Uuid
  allergenCode String @map("allergen_code") @db.VarChar(50)

  optionItem OptionItem @relation(fields: [optionItemId], references: [id], onDelete: Cascade)
  allergen   Allergen   @relation(fields: [allergenCode], references: [code], onDelete: Restrict)

  @@unique([tenantId, optionItemId, allergenCode])
  @@map("option_item_allergens")
}

// ============================================
// DIETARY FLAGS (Vegetarian, Vegan, Halal, etc.)
// ============================================
model DietaryFlag {
  code      String @id @db.VarChar(50)
  sortOrder Int    @default(0) @map("sort_order")

  translations DietaryFlagI18n[]
  itemFlags    ItemDietaryFlag[]

  @@map("dietary_flags")
}

model DietaryFlagI18n {
  id              String @id @default(uuid()) @db.Uuid
  dietaryFlagCode String @map("dietary_flag_code") @db.VarChar(50)
  locale          String @db.VarChar(10)
  name            String @db.VarChar(100)

  dietaryFlag DietaryFlag @relation(fields: [dietaryFlagCode], references: [code], onDelete: Cascade)

  @@unique([dietaryFlagCode, locale])
  @@map("dietary_flag_i18n")
}

model ItemDietaryFlag {
  id              String @id @default(uuid()) @db.Uuid
  tenantId        String @map("tenant_id") @db.Uuid
  itemId          String @map("item_id") @db.Uuid
  dietaryFlagCode String @map("dietary_flag_code") @db.VarChar(50)

  item        Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  dietaryFlag DietaryFlag @relation(fields: [dietaryFlagCode], references: [code], onDelete: Restrict)

  @@unique([tenantId, itemId, dietaryFlagCode])
  @@map("item_dietary_flags")
}

// ============================================
// INGREDIENTS (For items)
// ============================================
model Ingredient {
  id           String    @id @default(uuid()) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  name         String    @db.VarChar(255)
  allergenCode String?   @map("allergen_code") @db.VarChar(50)
  isAllergen   Boolean   @default(false) @map("is_allergen")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  ItemIngredient[]

  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@map("ingredients")
}

model ItemIngredient {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  itemId       String   @map("item_id") @db.Uuid
  ingredientId String   @map("ingredient_id") @db.Uuid
  quantity     String?  @db.VarChar(50)
  unit         String?  @db.VarChar(50)
  isOptional   Boolean  @default(false) @map("is_optional")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  item       Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([itemId, ingredientId])
  @@index([itemId])
  @@index([ingredientId])
  @@map("item_ingredients")
}

// ============================================
// ASSETS (Images, PDFs)
// ============================================
model Asset {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  kind        String   @default("image") @db.VarChar(20)
  storageUrl  String   @map("storage_url")
  contentType String?  @map("content_type") @db.VarChar(100)
  widthPx     Int?     @map("width_px")
  heightPx    Int?     @map("height_px")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  Item[]

  @@map("assets")
}

// ============================================
// SYSTEM PERMISSIONS (Platform-Level Permission Definitions)
// ============================================
model SystemPermission {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100) // e.g., "menu.read", "orders.update"
  label       String   @db.VarChar(100)
  description String?
  category    String   @db.VarChar(50) // e.g., "Menu", "Orders", "Analytics"
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  roles SystemRolePermission[]

  @@index([category])
  @@map("system_permissions")
}

// ============================================
// SYSTEM ROLES (Platform-Level Role Definitions)
// ============================================
model SystemRole {
  id          String   @id @default(uuid()) @db.Uuid
  slug        String   @unique @db.VarChar(50) // e.g., "owner", "manager"
  name        String   @db.VarChar(100)
  description String?
  icon        String?  @db.VarChar(10) // emoji icon
  color       String?  @db.VarChar(50) // tailwind classes
  level       Int      @default(0) // hierarchy level (higher = more privileges)
  isDefault   Boolean  @default(false) @map("is_default") // default role for new users
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  permissions SystemRolePermission[]

  @@index([level])
  @@map("system_roles")
}

// ============================================
// ROLE-PERMISSION MAPPING (Many-to-Many)
// ============================================
model SystemRolePermission {
  id           String   @id @default(uuid()) @db.Uuid
  roleId       String   @map("role_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  role       SystemRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission SystemPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("system_role_permissions")
}

// ============================================
// USERS & AUTH (Tenant-Level Users)
// ============================================
model AdminUser {
  id           String         @id @default(uuid()) @db.Uuid
  tenantId     String         @map("tenant_id") @db.Uuid
  username     String         @db.VarChar(100)
  email        String         @db.VarChar(255)
  displayName  String?        @map("display_name") @db.VarChar(255)
  passwordHash String         @map("password_hash")
  role         TenantUserRole @default(menu_editor)
  permissions  Json           @default("[]") // Additional granular permissions
  locationIds  String[]       @default([]) @map("location_ids") @db.Uuid // Restrict to specific locations
  isActive     Boolean        @default(true) @map("is_active")
  lastLogin    DateTime?      @map("last_login") @db.Timestamptz
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime?      @map("deleted_at") @db.Timestamptz

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  auditLogs AuditLog[]

  @@unique([tenantId, email, deletedAt])
  @@index([tenantId])
  @@map("admin_users")
}

// ============================================
// AUDIT & LOGGING
// ============================================
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String?  @map("tenant_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(100)
  entityId   String?  @map("entity_id") @db.Uuid
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address") @db.Inet
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  tenant Tenant?    @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   AdminUser? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============================================
// CHAT & AI SESSIONS
// ============================================
model ChatSession {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  sessionId String    @unique @map("session_id")
  metadata  Json      @default("{}")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  expiresAt DateTime? @map("expires_at") @db.Timestamptz

  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([tenantId])
  @@index([sessionId])
  @@map("chat_sessions")
}

model ChatMessage {
  id          String   @id @default(uuid()) @db.Uuid
  sessionId   String   @map("session_id") @db.Uuid
  role        String   @db.VarChar(20)
  content     String
  toolCalls   Json?    @map("tool_calls")
  toolResults Json?    @map("tool_results")
  tokenCount  Int?     @map("token_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

// ============================================
// SUBSCRIPTION PLANS
// ============================================
model SubscriptionPlan {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String   @db.VarChar(100)
  description        String?
  priceMonthly       Decimal  @map("price_monthly") @db.Decimal(10, 2)
  priceYearly        Decimal  @map("price_yearly") @db.Decimal(10, 2)
  maxMenuItems       Int      @default(100) @map("max_menu_items")
  maxLocations       Int      @default(1) @map("max_locations")
  maxApiCallsMonthly Int      @default(10000) @map("max_api_calls_monthly")
  features           Json     @default("[]")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz

  subscriptions RestaurantSubscription[]

  @@map("subscription_plans")
}

// ============================================
// RESTAURANT SUBSCRIPTIONS
// ============================================
enum SubscriptionStatus {
  active
  cancelled
  expired
  trial
}

enum BillingCycle {
  monthly
  yearly
}

model RestaurantSubscription {
  id           String             @id @default(uuid()) @db.Uuid
  restaurantId String             @unique @map("restaurant_id") @db.Uuid
  planId       String             @map("plan_id") @db.Uuid
  status       SubscriptionStatus @default(trial)
  startDate    DateTime           @map("start_date") @db.Timestamptz
  endDate      DateTime?          @map("end_date") @db.Timestamptz
  billingCycle BillingCycle       @default(monthly) @map("billing_cycle")
  autoRenew    Boolean            @default(true) @map("auto_renew")
  createdAt    DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  restaurant Tenant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  plan       SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([restaurantId])
  @@index([planId])
  @@map("restaurant_subscriptions")
}

// ============================================
// USAGE ANALYTICS
// ============================================
model UsageAnalytics {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  date         DateTime @db.Date
  apiCalls     Int      @default(0) @map("api_calls")
  chatSessions Int      @default(0) @map("chat_sessions")
  uniqueUsers  Int      @default(0) @map("unique_users")
  menuViews    Int      @default(0) @map("menu_views")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  restaurant Tenant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, date])
  @@index([restaurantId])
  @@index([date])
  @@map("usage_analytics")
}

// ============================================
// PLATFORM ADMIN USERS (SaaS-Level Roles)
// ============================================
enum PlatformAdminRole {
  super_admin     // Full access to all platform features
  support_agent   // Read-only access to tenant data, help troubleshoot
  billing_manager // Manage payment settings, invoices, plans
}

model PlatformAdmin {
  id           String            @id @default(uuid()) @db.Uuid
  email        String            @unique @db.VarChar(255)
  username     String            @db.VarChar(100)
  displayName  String?           @map("display_name") @db.VarChar(255)
  passwordHash String            @map("password_hash")
  role         PlatformAdminRole @default(support_agent)
  permissions  Json              @default("[]") // Additional granular permissions
  isActive     Boolean           @default(true) @map("is_active")
  lastLogin    DateTime?         @map("last_login") @db.Timestamptz
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime          @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime?         @map("deleted_at") @db.Timestamptz

  @@map("platform_admins")
}

// ============================================
// TENANT USER ROLES (Restaurant-Level Roles)
// ============================================
enum TenantUserRole {
  owner           // Full access to own restaurant(s)
  manager         // Manage menus, analytics, staff, orders
  menu_editor     // Create/edit menu items, sections, ingredients
  foh_staff       // Front of House - view menu, process orders
  kitchen_staff   // View orders, update status, ingredients
}
